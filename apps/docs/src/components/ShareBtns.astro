---
import { Flex, Icon, HTML } from 'lism-css/astro';
import { getLangFromUrl, t } from '@/lib/i18n';

interface Props {
	url: string;
	title: string;
	px?: ResponsiveValue<string | number>;
}

const { url, title, px } = Astro.props;
const lang = getLangFromUrl(Astro.url);
const shareText = t(lang, 'share');

// XのシェアURL生成
const xShareUrl = `https://twitter.com/intent/tweet?url=${encodeURIComponent(url)}&text=${encodeURIComponent(title)}`;
---

<Flex tag="aside" class="c--shareBtns" g="15" p="5" px={px}>
	{/* Xシェアボタン */}
	<HTML.a
		href={xShareUrl}
		target="_blank"
		rel="noopener noreferrer"
		fx="1"
		layout="flex"
		ai="center"
		jc="center"
		g="5"
		p="10"
		bd
		bdrs="10"
		class="c--shareBtn -c:inherit -td:none"
	>
		<Icon viewBox="0 0 256 256" width="1em" height="1em">
			<path
				d="M215,219.85a8,8,0,0,1-7,4.15H160a8,8,0,0,1-6.75-3.71l-40.49-63.63L53.92,221.38a8,8,0,0,1-11.84-10.76l61.77-68L41.25,44.3A8,8,0,0,1,48,32H96a8,8,0,0,1,6.75,3.71l40.49,63.63,58.84-64.72a8,8,0,0,1,11.84,10.76l-61.77,67.95,62.6,98.38A8,8,0,0,1,215,219.85Z"
			></path>
		</Icon>
		<span class="c--shareBtns__label -fz:2xs">{shareText.share}</span>
	</HTML.a>

	{/* URLコピーボタン */}
	<HTML.button
		class="c--shareBtn c--urlCopyBtn set-plain"
		fx="1"
		layout="flex"
		ai="center"
		jc="center"
		g="5"
		p="10"
		bd
		bdrs="10"
		data-url={url}
		arria-labelledby="label--url-copy"
	>
		<HTML.span class="c--urlCopyBtn__icon" layout="center">
			<svg
				class="a--icon -ga:1/1"
				xmlns="http://www.w3.org/2000/svg"
				fill="none"
				viewBox="0 0 24 24"
				stroke-width="1.5"
				stroke="currentColor"
				width="1em"
				height="1em"
				aria-hidden="true"
			>
				<path
					stroke-linecap="round"
					stroke-linejoin="round"
					d="M13.19 8.688a4.5 4.5 0 0 1 1.242 7.244l-4.5 4.5a4.5 4.5 0 0 1-6.364-6.364l1.757-1.757m13.35-.622 1.757-1.757a4.5 4.5 0 0 0-6.364-6.364l-4.5 4.5a4.5 4.5 0 0 0 1.242 7.244"
				></path>
			</svg>
			<svg
				class="a--icon -ga:1/1 _checked"
				xmlns="http://www.w3.org/2000/svg"
				fill="none"
				viewBox="0 0 24 24"
				stroke-width="1.5"
				stroke="currentColor"
				width="1em"
				height="1em"
				aria-hidden="true"
			>
				<path stroke-linecap="round" stroke-linejoin="round" d="m4.5 12.75 6 6 9-13.5"></path>
			</svg>
		</HTML.span>
		<span class="c--shareBtns__label -fz:2xs -lh:xs" id="label--url-copy">
			<span>{shareText.copy}</span>
			<span class="_checked">{shareText.copied}</span>
		</span>
	</HTML.button>

	<style>
		/* .c--shareBtns {} */
		.c--shareBtn:hover {
			background-color: var(--base-2);
		}

		/* URLコピーボタンのアイコン切り替え */
		._checked {
			opacity: 0;
			display: none;
		}

		/* コピー成功時のスタイル */
		.c--urlCopyBtn._copied {
			color: #0a9d6c;
			border-color: #16c288;

			> * > ._checked {
				opacity: 1;
				display: block;
			}
			> * > :not(._checked) {
				opacity: 0;
				display: none;
			}
		}
	</style>

	<script>
		// URLコピーボタンの動作を設定
		function initUrlCopyBtns() {
			const copyBtns = document.querySelectorAll('.c--urlCopyBtn');

			copyBtns.forEach((button) => {
				// 既にイベントリスナーが登録されている場合はスキップ
				if (button.hasAttribute('data-initialized')) return;
				button.setAttribute('data-initialized', 'true');

				button.addEventListener('click', async () => {
					const url = button.getAttribute('data-url');

					if (!url) return;

					try {
						// クリップボードにコピー
						await navigator.clipboard.writeText(url);

						// ボタンの表示を変更（成功フィードバック）
						button.classList.add('_copied');

						// 2秒後に元に戻す
						setTimeout(() => {
							button.classList.remove('_copied');
						}, 2000);
					} catch (err) {
						console.error('コピーに失敗しました:', err);
					}
				});
			});
		}

		// 初回ページ読み込み時
		if (document.readyState === 'loading') {
			document.addEventListener('DOMContentLoaded', initUrlCopyBtns);
		} else {
			initUrlCopyBtns();
		}

		// Astroのビュー遷移時（ビュー遷移が有効な場合）
		document.addEventListener('astro:page-load', initUrlCopyBtns);
	</script>
</Flex>
