---
// export const prerender = false; // このページはSSR

// import { Image } from 'astro:assets';
// import { Lism, LinkBox, Frame, Stack, Columns, Spacer, Media } from 'lism-css/astro';
import type { SidebarEntry } from '@/node_modules/@astrojs/starlight/utils/routing/types';
import { imageExists, isLibTabGroup } from '~/starlight/helper';
import LibTabs, { type NavLinkData } from './LibTabs';
// import { Tabs } from 'lism-css/react';

// import sidebarData from '@/astro-configs/sidebar';
const { sidebar } = Astro.locals.starlightRoute;

const { langPath = '', props } = Astro.props;

// Components と Templates のみ表示
const filteredTabGroup = sidebar.filter((entry) => {
	return isLibTabGroup(entry);
});

// console.log('filteredTabGroup', filteredTabGroup);

const ComponentNavList: SidebarEntry = filteredTabGroup[0];
const TemplateNavList: SidebarEntry = filteredTabGroup[1];
const LayoutNavList: SidebarEntry = filteredTabGroup[2];

// let defaultIndex = 1;
// SSRじゃないとクエリは受け取れない
// const url = new URL(Astro.request.url);
// const tab = url.searchParams.get('tab'); // 例: 'components', 'sections', 'templates'

const getPageLinkList = (entries: SidebarEntry[], type: string): NavLinkData[] => {
	if (!entries) return [];
	return entries
		.map<NavLinkData | null>((entry) => {
			if (entry.type === 'group') {
				return {
					type: 'group',
					label: entry.label.charAt(0).toUpperCase() + entry.label.slice(1),
					entries: getPageLinkList(entry.entries, type),
				};
			}

			if (entry.type !== 'link') return null;
			if (entry.href === '/###---') return null;

			let thumb = '';
			let imagePath = '';
			let iframePath = '';
			if (type === 'components') {
				imagePath = `/thumb/components/${entry.label}.png`;
				thumb = imageExists(imagePath) ? imagePath : '/thumb/components/Empty.png';
			} else {
				// hrefを'/'で分割し、最後から2つのセグメントを結合してファイル名を生成
				const segments = entry.href.replace(/\/+$/, '').split('/'); // 末尾スラッシュを除去して split
				const file = segments[segments.length - 1] || '';
				const cat = segments[segments.length - 2] || '';

				const path = type !== cat ? `${type}/${cat}/${file}` : `${type}/${file}`;
				imagePath = `/thumb/${path}.png`;
				// thumb = imageExists(imagePath) ? imagePath : '/thumb/components/Empty.png';
				if (!imageExists(imagePath)) {
					iframePath = `/${path}`;
				} else {
					thumb = imagePath;
				}
			}

			// entryのデータを返す
			return {
				type: 'link',
				href: `${langPath}${entry.href}`,
				label: entry.label,
				thumb,
				iframePath,
			};
		})
		.filter((data): data is NavLinkData => data !== null);
};

const componentList = ComponentNavList.type === 'group' ? getPageLinkList(ComponentNavList?.entries, 'components') : [];
const templateList = TemplateNavList.type === 'group' ? getPageLinkList(TemplateNavList?.entries, 'templates') : [];
const layoutList = LayoutNavList.type === 'group' && LayoutNavList.entries ? getPageLinkList(LayoutNavList.entries, 'page-layout') : [];
---

<LibTabs client:load componentList={componentList} templateList={templateList} layoutList={layoutList} />

<script>
	// memo: header.header の高さを取得して --header-h にセット
	function setHeaderHeightVar() {
		const header = document.querySelector('header.header') as HTMLElement;
		if (header) {
			const height = header.offsetHeight;
			document.documentElement.style.setProperty('--header-h', height + 'px');
		}
	}
	// 初回実行
	setHeaderHeightVar();
	// リサイズ時も再計算
	window.addEventListener('resize', setHeaderHeightVar);
</script>

<style is:inline>
	.d--tabs_list {
		position: sticky;
		top: var(--header-h, 3rem);
		/* background-color: var(--c--base); */
		z-index: 1;
		box-shadow:
			0 20px 30px 0px var(--c--base),
			0 20px 20px -10px var(--c--base);
		/* var(--c--base); */
		/* background-color: transparent;
		backdrop-filter: blur(16px);  */
	}
	.d--tabs_tab {
		padding-block: 0.5em;
	}
</style>
