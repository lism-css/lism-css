---
// export const prerender = false; // このページはSSR

// import { Image } from 'astro:assets';
import { Lism, LinkBox, Frame, Stack, Columns, Spacer, Media } from 'lism-css/astro';
import type { SidebarEntry } from '@/node_modules/@astrojs/starlight/utils/routing/types';
import { imageExists, isLibTabGroup } from '~/starlight/helper';
import LibTabs, { type NavLinkData } from './LibTabs';
import UIBlockList from './UIBlockList';
// import { Tabs } from 'lism-css/react';

// import sidebarData from '@/astro-configs/sidebar';
const { sidebar } = Astro.locals.starlightRoute;

const { langPath = '', target = '', cols = [2, 3, 4], ...props } = Astro.props;

// Library系ページのみ表示
const filteredTabGroup = sidebar.filter((entry) => {
	return isLibTabGroup(entry, target);
});

// console.log('filteredTabGroup', filteredTabGroup);

// const ComponentNavList: SidebarEntry = filteredTabGroup[0];
// const TemplateNavList: SidebarEntry = filteredTabGroup[1];
// const LayoutNavList: SidebarEntry = filteredTabGroup[2];

// let defaultIndex = 1;
// SSRじゃないとクエリは受け取れない
// const url = new URL(Astro.request.url);
// const tab = url.searchParams.get('tab'); // 例: 'components', 'sections', 'templates'

const getPageLinkList = (entries: SidebarEntry[], type: string): NavLinkData[] => {
	if (!entries) return [];
	return entries
		.map<NavLinkData | null>((entry) => {
			if (entry.type === 'group') {
				return {
					type: 'group',
					label: entry.label.charAt(0).toUpperCase() + entry.label.slice(1),
					entries: getPageLinkList(entry.entries, type),
				};
			}

			if (entry.type !== 'link') return null;
			if (entry.href === '/###---') return null;

			// index.mdx
			if (entry.href === `/lib/${target}/`) {
				return null;
			}

			let thumb = '';
			let imagePath = '';
			let iframePath = '';
			if (type === 'components') {
				imagePath = `/thumb/components/${entry.label}.png`;
				thumb = imageExists(imagePath) ? imagePath : '/thumb/components/Empty.png';
			} else {
				// hrefを'/'で分割し、最後から2つのセグメントを結合してファイル名を生成
				const segments = entry.href.replace(/\/+$/, '').split('/'); // 末尾スラッシュを除去して split
				const file = segments[segments.length - 1] || '';
				const cat = segments[segments.length - 2] || '';

				const path = type !== cat ? `${type}/${cat}/${file}` : `${type}/${file}`;
				imagePath = `/thumb/${path}.png`;
				// thumb = imageExists(imagePath) ? imagePath : '/thumb/components/Empty.png';
				if (!imageExists(imagePath)) {
					iframePath = `/${path}`;
				} else {
					thumb = imagePath;
				}
			}

			// entryのデータを返す
			return {
				type: 'link',
				href: `${langPath}${entry.href}`,
				label: entry.label,
				thumb,
				iframePath,
			};
		})
		.filter((data): data is NavLinkData => data !== null);
};

// const libraryList = ComponentNavList.type === 'group' ? getPageLinkList(ComponentNavList?.entries, target) : [];

// 各タブの設定
const TABS = [
	{ href: '/lib/components/', label: 'UI Components', target: 'components' },
	{ href: '/lib/templates/', label: 'Templates', target: 'templates' },
	{ href: '/lib/page-layout/', label: 'Page Layout', target: 'page-layout' },
];
---

{
	(() => {
		return (
			<div class='d--tabs--emboss'>
				<div class='d--tabs_list'>
					{TABS.map((tab) => {
						// lib/{target} が href と一致していれば aria-selected='true'
						const isSelected = target === tab.target;
						return (
							<a href={tab.href} class='d--tabs_tab set-plain' aria-selected={isSelected ? 'true' : 'false'}>
								{tab.label}
							</a>
						);
					})}
				</div>
			</div>
		);
	})()
}
{
	filteredTabGroup.map((entry) => {
		// console.log(entry);

		const libraryList = entry.type === 'group' ? getPageLinkList(entry?.entries, target) : [];
		// TABSからtargetに一致するlabelを取得
		// const tabLabel = TABS.find((tab) => tab.target === target)?.label || entry.label;
		return (
			<>
				{/* <h2>{tabLabel}</h2> */}
				<Columns cols={cols} style={{ 'content-visibility': 'auto' }}>
					<UIBlockList entries={libraryList} />
				</Columns>
			</>
		);
	})
}

<!-- <LibTabs client:load componentList={componentList} templateList={templateList} layoutList={layoutList} /> -->

<script>
	// memo: header.header の高さを取得して --header-h にセット
	function setHeaderHeightVar() {
		const header = document.querySelector('header.header') as HTMLElement;
		if (header) {
			const height = header.offsetHeight;
			document.documentElement.style.setProperty('--header-h', height + 'px');
		}
	}
	// 初回実行
	setHeaderHeightVar();
	// リサイズ時も再計算
	window.addEventListener('resize', setHeaderHeightVar);
</script>

<style>
	.d--tabs--emboss {
		position: sticky;
		top: var(--header-h, 3rem);
		/* background-color: var(--c--base); */
		z-index: 1;
		box-shadow:
			0 20px 30px 0px var(--c--base),
			0 20px 20px -10px var(--c--base);
		/* var(--c--base); */
		/* background-color: transparent;
		backdrop-filter: blur(16px);  */
	}
	.d--tabs_tab {
		padding-block: 0.5em;
	}
</style>
