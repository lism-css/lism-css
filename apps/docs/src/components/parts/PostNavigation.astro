---
/**
 * 前後記事ナビゲーションコンポーネント
 * sidebar.ts の順序に従って前後の記事へのリンクを表示
 * カテゴリ内に記事がない場合は次のカテゴリを探す
 */
import { Flex, Lism, HTML } from 'lism-css/astro';
import { getPostsByLang, type PostEntry } from '@/lib/content';
import { getRootLang, getLocalizedUrl, t, getPathWithoutLang, type LangCode } from '@/lib/i18n';
import sidebarConfig, { type SidebarSection, isSeparator, getSiteSection, extractSlugFromUrl } from '@/config/sidebar';

interface Props {
	currentSlug: string;
	lang?: LangCode; // 言語コード（省略時はroot言語）
}

const { currentSlug, lang = getRootLang() } = Astro.props;

// 現在のセクション（docs または ui）を取得
const currentPathWithoutLang = getPathWithoutLang(Astro.url);
const currentSection = getSiteSection(currentPathWithoutLang);

// 現在のセクションに対応するサイドバー設定を取得
const sectionItems = sidebarConfig.sections[currentSection];

/**
 * slugからURLパスを生成するヘルパー
 * - ui/xxx → /ui/xxx/
 * - xxx → /docs/xxx/
 */
function getPostUrl(slug: string): string {
	if (slug.startsWith('ui/')) {
		return `/${slug}/`;
	}
	return `/docs/${slug}/`;
}

// 指定言語の全記事を取得
const allPosts = await getPostsByLang(lang);

// カテゴリー（slugの最初の部分）でグループ化
const postsByCategory = allPosts.reduce(
	(acc, post) => {
		const hasSlash = post.slug.includes('/');
		const category = hasSlash ? post.slug.split('/')[0] : '/';
		if (!acc[category]) {
			acc[category] = [];
		}
		acc[category].push(post);
		return acc;
	},
	{} as Record<string, PostEntry[]>
);

// 各カテゴリー内を order → date 順にソート
Object.values(postsByCategory).forEach((posts) => {
	posts.sort((a, b) => {
		const orderA = a.data.order ?? 999;
		const orderB = b.data.order ?? 999;
		if (orderA !== orderB) return orderA - orderB;
		// order が同じ場合は日付順（新しい順）、date がない場合は 0 として扱う
		const dateA = a.data.date?.valueOf() ?? 0;
		const dateB = b.data.date?.valueOf() ?? 0;
		return dateB - dateA;
	});
});

// サイドバーセクションがdir指定かどうかをチェックするヘルパー
function hasDirProperty(item: SidebarSection): item is SidebarSection & { dir: string } {
	return 'dir' in item;
}

// sidebar.ts の順序で全記事をフラットに並べる
const orderedPosts: PostEntry[] = [];
for (const section of sectionItems) {
	if (hasDirProperty(section)) {
		// dir指定の場合：カテゴリ内の記事をソート順で追加
		const posts = postsByCategory[section.dir];
		if (posts && posts.length > 0) {
			orderedPosts.push(...posts);
		}
	} else {
		// items指定の場合：指定された順序で記事を追加
		for (const navItem of section.items) {
			// セパレータはスキップ
			if (isSeparator(navItem)) continue;
			// linkを取得（文字列の場合はそのまま、オブジェクトの場合は.linkプロパティ）
			const link = typeof navItem === 'string' ? navItem : navItem.link;
			// linkからslugを取得
			const slug = extractSlugFromUrl(link);
			const post = allPosts.find((p) => p.slug === slug);
			if (post) {
				orderedPosts.push(post);
			}
		}
	}
}

// 現在の記事のインデックスを取得
const currentIndex = orderedPosts.findIndex((post) => post.slug === currentSlug);

// 前後の記事を取得
const prevPost: PostEntry | undefined = currentIndex > 0 ? orderedPosts[currentIndex - 1] : undefined;
const nextPost: PostEntry | undefined = currentIndex < orderedPosts.length - 1 ? orderedPosts[currentIndex + 1] : undefined;

// 前後の記事がどちらもない場合は何も表示しない
const hasNavigation = prevPost || nextPost;

// 翻訳テキスト
const label = t(lang, 'postNav');
---

{
	hasNavigation && (
		<nav class="c--postNav" aria-label={label.ariaLabel}>
			<Flex fxw="wrap" g="20" jc="space-between">
				{/* 前の記事 */}
				<Lism class="c--postNav__item -prev">
					{prevPost ? (
						<a href={getLocalizedUrl(getPostUrl(prevPost.slug), lang)} class="c--postNav__link">
							<HTML.span class="c--postNav__label" fz="xs" o="-10">
								{label.prev}
							</HTML.span>
							<HTML.span class="c--postNav__title">{prevPost.data.navtitle || prevPost.data.title}</HTML.span>
						</a>
					) : (
						<Lism class="c--postNav__empty" />
					)}
				</Lism>

				{/* 次の記事 */}
				<Lism class="c--postNav__item -next">
					{nextPost ? (
						<a href={getLocalizedUrl(getPostUrl(nextPost.slug), lang)} class="c--postNav__link">
							<HTML.span class="c--postNav__label" fz="xs" o="-10">
								{label.next}
							</HTML.span>
							<HTML.span class="c--postNav__title">{nextPost.data.navtitle || nextPost.data.title}</HTML.span>
						</a>
					) : (
						<Lism class="c--postNav__empty" />
					)}
				</Lism>
			</Flex>
		</nav>
	)
}
