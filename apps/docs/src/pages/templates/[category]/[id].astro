---
/**
 * テンプレート詳細ページ（動的ルーティング）
 *
 * URL: /templates/{category}/{id}
 * 例: /templates/cta/cta001
 *
 * プレビューiframeは /templates/{category}/{id}/preview/ を参照
 */
import BaseLayout from '@/layouts/BaseLayout.astro';
import { Stack, Flow, Frame, Text, HTML } from 'lism-css/astro';
import { PreviewFrame, PreviewTitle } from '@/components/Preview';
import SrcCode from '@/components/mdx/SrcCode.astro';
import { templates, type TemplateCategoryId } from '@/config/templates';
import { getAllTemplatePaths, getTemplate } from '@/lib/templates';

// 静的パス生成
export function getStaticPaths() {
	const paths = getAllTemplatePaths();
	return paths.map(({ category, id }) => ({
		params: { category, id },
	}));
}

// Params取得
const { category, id } = Astro.params;
const template = getTemplate(category!, id!);

// テンプレートが見つからない場合は404
if (!template) {
	return Astro.redirect('/404');
}

// カテゴリ情報
const categoryData = templates[category as TemplateCategoryId];

// プレビューURLとコード埋め込み用のパス
const previewUrl = `/preview/templates/${category}/${id}/`;
const templatePath = `src/pages/preview/templates/${category}/${id}`;

// GitHub埋め込み用URL（旧docsと同じ形式）
const branch = import.meta.env.MODE === 'development' ? 'dev' : 'main';
const githubBasePath = `https://github.com/lism-css/lism-css/blob/${branch}/apps/docs-new/${templatePath}/index.astro`;
const queryMeta = 'style=github-dark&type=code&showLineNumbers=on&showFileMeta=on&showCopy=on';
---

<BaseLayout title={`${template.title} - Templates`} description={template.description} excludeFromSearch>
	<Flow g="30" class="templatePage">
		<Stack tag="header" g="10">
			<Text fz="xs" c="text-2" tt="uppercase" lts="l">
				{categoryData.label}
			</Text>
			<h1 class="-fz:3xl -fw:bold">{template.title}</h1>
			<Text c="text-2">{template.description}</Text>
		</Stack>
		{
			template.draft && (
				<HTML.div class="draftBadge" fz="xs" w="fit" bgc="red" c="base" bdrs="10" px="10">
					DRAFT
				</HTML.div>
			)
		}
		{/* プレビュー */}
		<HTML.div layout="flow" my-s="50">
			<!-- <PreviewTitle>プレビュー</PreviewTitle> -->
			<PreviewFrame url={previewUrl} hasSizeSwitch />
		</HTML.div>

		{/* ソースコード */}
		<Stack g="15">
			<PreviewTitle>コード</PreviewTitle>
			<SrcCode dir="docs" path={templatePath + '/index.astro'} title="index.astro" />
			<SrcCode dir="docs" path={templatePath + '/_style.css'} title="style.css" />
			<!-- <Frame ov-y="auto" max-h="25rem" class="code-embed">
				<script src={`https://emgithub.com/embed-v2.js?target=${encodeURI(githubBasePath)}&${queryMeta}`} loading="lazy"></script>
			</Frame> -->
		</Stack>
	</Flow>
</BaseLayout>

<style>
	.templatePage {
		/* 詳細ページ固有のスタイル */
	}

	.code-embed {
		border-radius: var(--bdrs--15);
		overflow: hidden;
	}
</style>
