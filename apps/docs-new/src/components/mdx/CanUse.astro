---
/**
 * ブラウザサポート状況を横並びで表示するコンポーネント
 */

import { Icon, HTML } from 'lism-css/astro';

// ブラウザのバージョンとリリース日のマッピング
const BROWSER_RELEASES: Record<string, Record<string, string>> = {
	chrome: {
		'143': '2025/12', '142': '2025/10', '141': '2025/9', '140': '2025/9',
		'139': '2025/8', '138': '2025/6', '137': '2025/5', '136': '2025/4',
		'135': '2025/4', '134': '2025/3', '133': '2025/2', '132': '2025/1',
		'131': '2024/11', '130': '2024/10', '129': '2024/9', '128': '2024/8',
		'127': '2024/7', '126': '2024/6', '125': '2024/5', '124': '2024/4',
		'123': '2024/3', '122': '2024/2', '121': '2024/1', '120': '2023/12',
		'119': '2023/10', '118': '2023/10', '117': '2023/9', '116': '2023/8',
		'115': '2023/7', '114': '2023/5', '113': '2023/5', '112': '2023/4',
		'111': '2023/3', '110': '2023/2', '109': '2023/1', '108': '2022/11',
		'107': '2022/10', '106': '2022/9', '105': '2022/8', '104': '2022/8',
		'103': '2022/6', '102': '2022/5', '101': '2022/4', '100': '2022/3',
		'99': '2022/3', '98': '2022/2', '97': '2022/1', '96': '2021/11',
		'95': '2021/10', '94': '2021/9', '93': '2021/8', '92': '2021/7',
		'91': '2021/5', '90': '2021/4', '89': '2021/3', '88': '2021/1',
		'87': '2020/11', '86': '2020/10', '85': '2020/8', '84': '2020/7',
		'83': '2020/5', '81': '2020/4', '80': '2020/2', '79': '2020/1',
	},
	safari: {
		'26': '2025/9', '26.0': '2025/9', '26.1': '2025/11', '26.2': '2025/12',
		// Safari 18.x系
		'18.5': '2025/5', '18.4': '2025/3', '18.3': '2025/1', '18.2': '2024/12',
		'18.1': '2024/10', '18': '2024/9', '18.0': '2024/9',
		// Safari 17.x系
		'17.6': '2024/7', '17.5': '2024/5', '17.4': '2024/3', '17.3': '2024/1',
		'17.2': '2023/12', '17.1': '2023/10', '17': '2023/9', '17.0': '2023/9',
		// Safari 16.x系
		'16.6': '2023/7', '16.5': '2023/5', '16.4': '2023/3', '16.3': '2023/1',
		'16.2': '2022/12', '16.1': '2022/10', '16': '2022/9', '16.0': '2022/9',
		// Safari 15.x系
		'15.6': '2022/7', '15.5': '2022/5', '15.4': '2022/3', '15.3': '2022/1',
		'15.2': '2021/12', '15.1': '2021/10', '15': '2021/9', '15.0': '2021/9',
		// Safari 14.x系
		'14.1': '2021/4', '14': '2020/9', '14.0': '2020/9',
	},
	firefox: {
		'146': '2025/12', '145': '2025/11', '144': '2025/10', '143': '2025/9',
		'142': '2025/8', '141': '2025/7', '140': '2025/6', '139': '2025/5',
		'138': '2025/4', '137': '2025/4', '136': '2025/3', '135': '2025/2',
		'134': '2025/1', '133': '2024/11', '132': '2024/10', '131': '2024/10',
		'130': '2024/9', '129': '2024/8', '128': '2024/7', '127': '2024/6',
		'126': '2024/5', '125': '2024/4', '124': '2024/3', '123': '2024/2',
		'122': '2024/1', '121': '2023/12', '120': '2023/11', '119': '2023/10',
		'118': '2023/9', '117': '2023/8', '116': '2023/8', '115': '2023/7',
		'114': '2023/6', '113': '2023/5', '112': '2023/4', '111': '2023/3',
		'110': '2023/2', '109': '2023/1', '108': '2022/12', '107': '2022/11',
		'106': '2022/10', '105': '2022/9', '104': '2022/8', '103': '2022/7',
		'102': '2022/6', '101': '2022/5', '100': '2022/5', '99': '2022/4',
		'98': '2022/3', '97': '2022/2', '96': '2022/1', '95': '2021/12',
		'94': '2021/11', '93': '2021/10', '92': '2021/9', '91': '2021/8',
		'90': '2021/7', '89': '2021/6', '88': '2021/4', '87': '2021/3',
		'86': '2021/2', '85': '2021/1', '84': '2020/12', '83': '2020/11',
		'82': '2020/10', '81': '2020/9', '80': '2020/8', '79': '2020/7', '78': '2020/6',
	},
	// Edge は Chromium ベースなので Chrome とほぼ同じリリーススケジュール
	edge: {
		'79': '2020/1'
	},
};

interface Props {
	/** プロパティ名（任意、表示用） */
	prop?: string;
	/** Chrome のサポートバージョン（"x" または未指定で未対応） */
	chrome?: string;
	/** Firefox のサポートバージョン（"x" または未指定で未対応） */
	firefox?: string;
	/** Safari のサポートバージョン（"x" または未指定で未対応） */
	safari?: string;
	/** Edge のサポートバージョン（"x" または未指定で未対応） */
	edge?: string;
}

const { prop, chrome, firefox, safari, edge } = Astro.props;

// バージョン文字列をサポート状況に変換
const formatSupport = (version: string | undefined, browserName: string) => {
	// "x" または未指定の場合は未対応
	if (!version || version.toLowerCase() === 'x') {
		return { supported: false, text: '' };
	}

	// バージョン番号を正規化（数字のみ or 数字.数字 形式に）
	const normalizedVersion = version.trim();
	const releases = BROWSER_RELEASES[browserName.toLowerCase()];
	const releaseDate = releases?.[normalizedVersion];

	// リリース日が見つかった場合は「バージョン (年/月)」形式で表示
	if (releaseDate) {
		return { supported: true, text: `${normalizedVersion} (${releaseDate})` };
	}

	// リリース日が見つからない場合はバージョンのみ表示
	return { supported: true, text: normalizedVersion };
};

// 各ブラウザのサポート状況（アイコンパスを含む）
const browsers = [
	{ name: 'Chrome', icon: '/svg/chrome.svg', ...formatSupport(chrome, 'chrome') },
	// Edge は指定された場合のみ表示
	...(edge !== undefined ? [{ name: 'Edge', icon: '/svg/edge.svg', ...formatSupport(edge, 'edge') }] : []),
	{ name: 'Safari', icon: '/svg/safari.svg', ...formatSupport(safari, 'safari') },
	{ name: 'Firefox', icon: '/svg/firefox.svg', ...formatSupport(firefox, 'firefox') },
	
];
---

<HTML.div layout="stack" bdrs="10" bgc="base-2" class="c--canuse" >
	<HTML.span layout="flex" ai="center" class="c--canuse__prop" px="15" bdc='base' bd-b _aslf='start' >
		<HTML.span c="text-2" py='5' bdc='base' bd-x-e px-e='15' mx-e='15' fz="2xs">Can Use ?</HTML.span>
		<HTML.span fz="xs" ff='mono'>{prop}</HTML.span>
	</HTML.span>
	<!-- {prop && <span class="c--canuse__prop">{prop}</span>} -->
	<HTML.span layout="cluster" class="c--canuse__browsers" lh="1" z="1" g="10" p='20'>
		{
			browsers.map((browser) => (
				<HTML.span layout="flex" ai="center" class:list={['c--canuse__browser', browser.supported ? '-supported' : '-unsupported']}>
					<img class="c--canuse__appimg" src={browser.icon} alt={browser.name} width="20" height="20" />
					<HTML.span class="c--canuse__icon" layout="center">
						<Icon icon={browser.supported ? 'check' : 'x'}  />
					</HTML.span>
					{browser.supported ? <HTML.span fz="xs" px="5" c="text-2">{browser.text}~</HTML.span> : <></>}
				</HTML.span>
			))
		}
	</HTML.span>
</HTML.div>

<style>
	.c--canuse {
		+ .c--canuse {
			margin-block-start: .5em;
		}
	}

	.c--canuse__appimg {
		width: 1.375em;
		height: 1.375em;
	}

	.-supported {
		--_icon-c: #0ea646;
	}
	.-unsupported {
		--_icon-c: #c61717;
	}
	.c--canuse__icon {
		color: var(--_icon-c, currentColor);
		border-radius: 50%;
		border: 1px solid;
		padding: .125em;
		margin-inline-start: -0.25em;
		z-index: -1;
	}


</style>
