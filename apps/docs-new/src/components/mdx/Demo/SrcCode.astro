---
/**
 * ファイルの中身をコードブロックで表示するコンポーネント
 *
 * 使用例:
 * <CodeFile path="src/styles/base.css" />
 * <CodeFile path="src/styles/base.css" title="ベーススタイル" />
 *
 * NOTE: 行番号表示などの高度な機能が必要な場合は、
 * ファイル内容を直接MDXに記述してExpressive Codeを使用してください
 */
import { Code } from 'astro:components';
import { readFileSync, existsSync } from 'node:fs';
import { resolve, basename } from 'node:path';
import { Icon, HTML } from 'lism-css/astro';
import CopyBtn from './CopyBtn.astro';

interface Props {
	/**
	 * ファイルパス（プロジェクトルートからの相対パスまたは絶対パス）
	 */
	path: string;

	/**
	 * シンタックスハイライトの言語
	 * 指定しない場合は拡張子から自動判定
	 */
	lang?: string;

	/**
	 * コードブロックのタイトル（任意）
	 * 指定した場合はコードブロックの上部に表示
	 */
	title?: string;
}

const { path, lang, title } = Astro.props;

// プロジェクトルートからの絶対パスを解決
const projectRoot = resolve(process.cwd());
const filePath = path.startsWith('/') ? path : resolve(projectRoot, path);

// ファイルの読み込み
let fileContent: string = '';
let error: string = '';

if (!existsSync(filePath)) {
	console.error(`[CodeFile] File not found: ${filePath}`);
	error = `Error: ファイルが見つかりません: ${path}`;
} else {
	try {
		fileContent = readFileSync(filePath, 'utf-8');
	} catch (err) {
		console.error(`[CodeFile] Failed to read file: ${filePath}`, err);
		error = `Error: ファイルの読み込みに失敗しました: ${path}`;
	}
}

// 言語の自動判定（langが指定されていない場合）
const detectedLang = lang || detectLanguage(path);

/**
 * ファイル拡張子から言語を判定
 */
function detectLanguage(filePath: string): string {
	const ext = filePath.split('.').pop()?.toLowerCase() || '';

	// 拡張子と言語のマッピング
	const langMap: Record<string, string> = {
		js: 'javascript',
		jsx: 'jsx',
		ts: 'typescript',
		tsx: 'tsx',
		css: 'css',
		scss: 'scss',
		html: 'html',
		md: 'markdown',
		mdx: 'mdx',
		json: 'json',
		yaml: 'yaml',
		sh: 'bash',
		bash: 'bash',
		svg: 'xml',
		astro: 'astro',
	};

	return langMap[ext] || 'text';
}
---

<div class="c--srcCode">
	{
		title && (
			<HTML.div class="c--srcCode__title" layout="flex" ai="center" g="10" bgc="base-2" lh="1">
				<Icon viewBox="0 0 256 256" fz="l">
					<path d="M181.66,146.34a8,8,0,0,1,0,11.32l-24,24a8,8,0,0,1-11.32-11.32L164.69,152l-18.35-18.34a8,8,0,0,1,11.32-11.32Zm-72-24a8,8,0,0,0-11.32,0l-24,24a8,8,0,0,0,0,11.32l24,24a8,8,0,0,0,11.32-11.32L91.31,152l18.35-18.34A8,8,0,0,0,109.66,122.34ZM216,88V216a16,16,0,0,1-16,16H56a16,16,0,0,1-16-16V40A16,16,0,0,1,56,24h96a8,8,0,0,1,5.66,2.34l56,56A8,8,0,0,1,216,88Zm-56-8h28.69L160,51.31Zm40,136V96H152a8,8,0,0,1-8-8V40H56V216H200Z" />
				</Icon>
				<span class="-fz:xs">{title}</span>
			</HTML.div>
		)
	}
	{
		error ? (
			<div class="c--srcCode__error -p:30">{error}</div>
		) : (
			<div class="c--srcCode__content -pos:rel">
				<Code code={fileContent} lang={detectedLang as any} themes={{ light: 'github-light', dark: 'github-dark' }} />
				<CopyBtn fileContent={fileContent} />
			</div>
		)
	}
</div>

<style>
	.c--copyBtn {
		opacity: 0;
		transition: opacity 0.3s;

		&:hover {
			opacity: 1;
		}
	}
	.c--srcCode {
		max-width: 100%;
	}
	.c--srcCode__title {
		/* コードブロックのタイトルスタイル */
		padding: 0.5em 0.75em;
		border-radius: var(--bdrs--10) var(--bdrs--10) 0 0;
	}

	.c--srcCode__content {
		overflow-x: auto;
		max-width: 100%;
	}

	.c--srcCode__error {
		/* エラー時のスタイル */
		border: 2px solid #ff4444;
		color: #d32f2f;
		background: #fff1f1;
	}
</style>
