---
/**
 * 言語切り替えセレクトコンポーネント
 * 現在のページの他言語バージョンへのリンクを表示
 */
import { Lism, HTML, Icon } from 'lism-css/astro';
import { getLangFromUrl, getAlternateUrls, getLangLabel, t } from '@/lib/i18n';

interface Props {
	class?: string;
}

// 現在のURLから言語を取得
const currentLang = getLangFromUrl(Astro.url);

// 他言語バージョンのURLを取得
const alternateUrls = getAlternateUrls(Astro.url);

// 翻訳テキスト
const langSelectText = t(currentLang, 'langSelect');
---

<div class:list={['c--langSelect -pos:rel', Astro.props.class]}>
	<HTML.button
		type="button"
		class="c--langSelect__trigger l--flex -ai:center"
		p="10"
		bgc="base"
		bdrs="10"
		hov={{ bgc: 'base-2' }}
		aria-expanded="false"
		aria-haspopup="listbox"
		aria-label={langSelectText.ariaLabel}
	>
		<Icon viewBox="0 0 256 256" fz="l">
			<path
				d="M247.15,212.42l-56-112a8,8,0,0,0-14.31,0l-21.71,43.43A88,88,0,0,1,108,126.93,103.65,103.65,0,0,0,135.69,64H160a8,8,0,0,0,0-16H104V32a8,8,0,0,0-16,0V48H32a8,8,0,0,0,0,16h87.63A87.76,87.76,0,0,1,96,116.35a87.74,87.74,0,0,1-19-31,8,8,0,1,0-15.08,5.34A103.63,103.63,0,0,0,84,127a87.55,87.55,0,0,1-52,17,8,8,0,0,0,0,16,103.46,103.46,0,0,0,64-22.08,104.18,104.18,0,0,0,51.44,21.31l-26.6,53.19a8,8,0,0,0,14.31,7.16L148.94,192h70.11l13.79,27.58A8,8,0,0,0,240,224a8,8,0,0,0,7.15-11.58ZM156.94,176,184,121.89,211.05,176Z"
			></path>
		</Icon>
		<HTML.span class="c--langSelect__current" fz="xs" lh="xs" c="text-2">{getLangLabel(currentLang)}</HTML.span>
		<Icon icon="caret-down" fz="xs" class="c--langSelect__arrow" />
	</HTML.button>

	<Lism tag="ul" class="c--langSelect__menu" bgc="base" bdrs="10" bxsh="10" role="listbox" aria-label={langSelectText.menuAriaLabel}>
		{
			alternateUrls.map(({ lang, url }) => (
				<HTML.li role="option" aria-selected={lang === currentLang}>
					<a href={url} class:list={['c--langSelect__item', { '-active': lang === currentLang }]} lang={lang} hreflang={lang}>
						{getLangLabel(lang)}
					</a>
				</HTML.li>
			))
		}
	</Lism>
</div>

<style>
	/* .c--langSelect {} */

	.c--langSelect__trigger {
		gap: 0.375em;
		cursor: pointer;
	}

	.c--langSelect__arrow {
		transition: transform 0.2s;
	}

	.c--langSelect[data-open] .c--langSelect__arrow {
		transform: rotate(180deg);
	}

	.c--langSelect__menu {
		position: absolute;
		bottom: 100%; /* 上に表示 */
		left: 0;
		z-index: 100;
		min-width: 120px;
		margin-bottom: 0.25em;
		padding: 0.25em;
		opacity: 0;
		visibility: hidden;
		transform: translateY(0.5em); /* 下から上へのアニメーション */
		transition:
			opacity 0.2s,
			visibility 0.2s,
			transform 0.2s;
	}

	.c--langSelect[data-open] .c--langSelect__menu {
		opacity: 1;
		visibility: visible;
		transform: translateY(0);
	}

	.c--langSelect__item {
		display: block;
		padding: 0.5em 0.75em;
		font-size: var(--fz--s);
		color: inherit;
		text-decoration: none;
		border-radius: var(--bdrs--5);
		transition: background-color 0.2s;
	}

	.c--langSelect__item:hover {
		background: var(--base-2);
	}

	.c--langSelect__item.-active {
		font-weight: bold;
		background: var(--base-2);
	}
</style>

<script>
	// 言語セレクトのトグル動作
	document.querySelectorAll('.c--langSelect').forEach((select) => {
		const trigger = select.querySelector('.c--langSelect__trigger');
		if (!trigger) return;

		// クリックでメニュー開閉
		trigger.addEventListener('click', () => {
			const isOpen = select.hasAttribute('data-open');
			if (isOpen) {
				select.removeAttribute('data-open');
				trigger.setAttribute('aria-expanded', 'false');
			} else {
				select.setAttribute('data-open', '');
				trigger.setAttribute('aria-expanded', 'true');
			}
		});

		// 外側クリックで閉じる
		document.addEventListener('click', (e) => {
			if (!select.contains(e.target as Node)) {
				select.removeAttribute('data-open');
				trigger.setAttribute('aria-expanded', 'false');
			}
		});

		// Escキーで閉じる
		document.addEventListener('keydown', (e) => {
			if (e.key === 'Escape') {
				select.removeAttribute('data-open');
				trigger.setAttribute('aria-expanded', 'false');
			}
		});
	});
</script>
