---
/**
 * 記事詳細ページ（非root言語用）
 * - 非root言語（en等）の記事を表示
 * - 翻訳がない場合はroot言語にフォールバック（未翻訳の注意書き付き）
 * - URL例: /en/docs/introduction, /en/docs/layout/grid-layout
 */
import BaseLayout from '@/layouts/BaseLayout.astro';
import { generateToc } from '@/lib/generateToc';
import { Cluster, Stack, Lism, Flow, HTML } from 'lism-css/astro';
import PostNavigation from '@parts/PostNavigation.astro';
import TranslationNotice from '@/components/TranslationNotice.astro';
import { getPostPathsForNonRoot } from '@/lib/pageHelpers';
import { getPostWithFallback } from '@/lib/content';
import { isValidLang, getLocalizedUrl, type LangCode } from '@/lib/i18n';

// MDXでグローバルに使用するコンポーネント
import * as mdxComponents from '@/components/mdx';

// 共通ヘルパーを使用
export const getStaticPaths = getPostPathsForNonRoot;

interface Props {
	lang: LangCode;
	slug: string;
}

const { lang, slug } = Astro.props;

// 言語が無効な場合は404
if (!isValidLang(lang)) {
	return Astro.redirect('/404');
}

// 記事を取得（なければフォールバック）
const { entry, isFallback } = await getPostWithFallback(lang, slug);

// 記事が見つからない場合は404
if (!entry) {
	return Astro.redirect('/404');
}

const { Content, headings } = await entry.render();
const toc = generateToc(headings);

// アイキャッチ画像: heroがあればそれを、なければOG画像を使用
const eyecatchImage = entry.data.hero || `/${lang}/docs/og/${slug}.png`;
// OG画像のパス
const ogImage = `/${lang}/docs/og/${slug}.png`;
---

<BaseLayout title={entry.data.title} description={entry.data.description} ogImage={ogImage} toc={toc} lang={lang}>
	{/* フォールバック（未翻訳）ページは検索対象から除外 */}
	<Stack tag="article" class="z--article" g="40" class="set-cqUnit" {...!isFallback && { 'data-pagefind-body': true }}>
		{/* 未翻訳の注意書き */}
		{isFallback && <TranslationNotice lang={lang} />}

		{/* アイキャッチ画像 */}
		{
			// (
			// 	<Frame ar="1200/630" bdrs="20" ov="hidden" bxsh="2">
			// 		<img src={eyecatchImage} alt={entry.data.title} />
			// 	</Frame>
			// )
		}

		{/* 記事タイトル */}
		<HTML.h lv="1" class="article-title">{entry.data.title}</HTML.h>

		{/* 記事本文 */}
		<Flow class="article-content" my-s="40">
			<Content components={mdxComponents} />
		</Flow>

		{/* 前後記事ナビゲーション */}
		<PostNavigation currentSlug={slug} lang={lang} />
	</Stack>
</BaseLayout>

